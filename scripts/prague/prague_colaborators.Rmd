---
title: "prague_colaborators"
author: "RRPS"
date: '2022-07-14'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(
	fig.height = 5,
	fig.width = 8,
	dpi = 180,
	message = FALSE,
	warning = FALSE,
	cache = TRUE,
	echo = TRUE
)
```

```{r CLEAR EVERYTHING, eval=FALSE, include=FALSE}
# unload all non-base packages
lapply(names(sessionInfo()$otherPkgs), function(pkgs)
  detach(
    paste0('package:', pkgs),
    character.only = T,
    unload = T,
    force = T
))

rm(list=ls())
```

```{r load libraries, message=FALSE, warning=FALSE, include=FALSE}
# load the packages
# main packs to start with
pcks <- c( "tidyverse", "janitor")
# require("tidyverse")

if(sum(as.numeric(!pcks %in% installed.packages())) != 0){
  installation <- pcks[!pcks %in% installed.packages()]
  for(i in 1:length(installation)) {
    install.packages(installation, dependencies = T)
    break()}
  suppressPackageStartupMessages(
  sapply(pcks,require,character.only = T)
) 
} else {
  suppressPackageStartupMessages(
  sapply(pcks,require,character.only = T)
) 
}

rm(pcks)
```

# setting working directories
```{r directories}
# get working directory and paste directory to save outputs
# in the Knit dropdown menu, select Knit directory, then Current Working Directory.
# dir.create("~/R/microbiome_br/scripts")
# dir.create("~/R/microbiome_br/outputs")
# dir.create("~/R/microbiome_br/data")
work_dir <- getwd()
folder_path <- "~/R/microbiome_br/outputs/prague/"
#folder_path <- "../../../microbiome_br_2/"
data.dir <- paste0(work_dir, "/data/prague")
# dir.create("data")
# dir.create(data.dir)
setwd(data.dir)

# # set colors
# color_distance <- c("D0" = "deepskyblue2", 'D1' = 'brown1',  "D2" = "forestgreen", "D3" = "#440154FF", "D4" = "burlywood")
# # color_distance1 <- c('D1' = 'brown1',  "D2" = "forestgreen", "D3" = "#440154FF", "D4" = "burlywood")
# color_depth <- c('DP1'="darkorange",'DP2'="purple", "DP3" = "cyan4")
# color_sites <- c(lease_1 = "#56B4E9", lease_2 ="#E69F00"  , Control =  "#009E73", other_leases = "#D1BCA8")

# check the working directory
paste("Working in directory:", getwd())
```

# data

if the status in "Complete Genome" < 8: get the biggest Status. if > 8: make 3 column with Q1, median, and Q3 and count the genomes.
If there isnÂ´t Complete Genome > Scaffold > Contig > Chromosome 

```{r get the data}
# eukaryotic table
euk <- read_delim('eukaryotes.txt')
#euk <- read_delim('../../../microbiome_br_2/eukaryotes.txt')

euk.clean <- euk %>% 
  mutate(`#Organism/Name` = str_replace_all(`#Organism/Name`, "\\[|\\]","")) %>% 
  mutate(Organism = `#Organism/Name`, .after = `#Organism/Name`) %>%
  janitor::clean_names(.)

# take a look in the data
euk.clean %>% filter(if_any(everything(), ~str_detect(., "Candida albicans"))) %>% pull(status, organism)

# prokaryotic table
prok <- read_delim('prokaryotes.txt')
#prok <- read_delim('../../../microbiome_br_2/prokaryotes.txt')

prok.clean <- prok %>% 
  mutate(`#Organism/Name` = str_replace_all(`#Organism/Name`, "\\[|\\]","")) %>% 
  mutate(Organism = `#Organism/Name`, .after = `#Organism/Name`) %>%
  janitor::clean_names(.)

#prok %>% slice(102225)

# lets take a look in the databases
prok.clean %>% filter(if_any(everything(), ~str_detect(., "Koribacter versatilis Ellin345"))) %>% 
  filter(if_any(status, ~str_detect(., "Complete")))

prok %>% filter(if_any(everything(), ~str_detect(., "Candidatus")))

# table final
final.table <- read_delim('MG_FEDERICA_TABLE_FINAL.tab')
#final.table <- read_delim('../../../microbiome_br_2/MG_FEDERICA_TABLE_FINAL.tab')

# it removes any instance of '[' or ']'
table.clean <- final.table %>% 
  mutate(BEST_TAX = str_replace_all(BEST_TAX, "\\[|\\]","")) %>% 
  rename('number_organism_name' = 'BEST_TAX') %>%
  mutate(organism = number_organism_name, .after = number_organism_name) %>%
  clean_names()

table.clean %>% select(number_organism_name) %>% filter(if_any(everything(), ~str_detect(., "Candidatus")))
table.clean %>% distinct(number_organism_name)

# get the taxonomies freom Federica table
taxonomies_federica <- table.clean %>% filter(number_organism_name != "-") %>% pull(number_organism_name) %>% as.factor() %>% levels()

rm(euk,prok)

```

Extract the information based on the taxonomies
For prokaryotes 
```{r}
# filter prok table
prok.info <- prok.clean %>% 
              select(number_organism_name, organism, size_mb, gc_percent, status) %>% 
              mutate(gc_percent = as.numeric(gc_percent))
best_tax_prok <- taxonomies_federica %>% map_df(., ~prok.info  %>% 
                                               filter(str_detect(organism, .x)) %>% 
                                               mutate(taxonomy = .x)
                                       )

table.clean %>% select(number_organism_name) %>% filter(if_any(everything(), ~str_detect(., 'Magnetococcus')))
prok.info %>% filter(if_any(everything(), ~str_detect(., 'Magnetococcus')))
best_tax_prok %>% filter(if_any(everything(), ~str_detect(., 'Magnetococcus')))
#Check_names <- best_tax_prok %>% filter(if_any(everything(), ~str_detect(., 'Candidatus')))

# Store hits found
write.table(x = best_tax_prok, file = paste0(folder_path, "/federica_found_taxonomy_prok.txt"), quote = F, sep = "\t", row.names = F)

## read hits found. Avoid running all steps again.
# best_tax_prok <- read_delim(file = paste0(folder_path, "/federica_found_taxonomy_prok.txt"))
# best_tax_prok <- read_delim(file = paste0(folder_path, "federica_found_taxonomy_prok.txt"))

# Checking for differences between organism name and Taxonomy from FEDERICA's table
#options(pillar.print_max = 10, pillar.print_min = 10, pillar.width = 35)

which(best_tax_prok$number_organism_name != best_tax_prok$taxonomy)
best_tax_prok[which(best_tax_prok$number_organism_name != best_tax_prok$taxonomy), c(1,6)]

waldo::compare(best_tax_prok$number_organism_name, best_tax_prok$taxonomy)

```


For eukaryotes
```{r}
# filter euk table
euk.info <- euk.clean %>% 
              select(number_organism_name, organism, size_mb, gc_percent, status) %>% 
              mutate(gc_percent = as.numeric(gc_percent))
# Indentify taxa without GC content info (353 found)
# euk.info[which(is.na(euk.info$gc_percent)),]
euk.info %>% filter(is.na(gc_percent))

best_tax_euk <- taxonomies_federica %>% map_df(., ~euk.info  %>% 
                                              filter(str_detect(organism, .x)) %>% 
                                              mutate(taxonomy = .x)
                                      )
# Store euk hits found
write.table(x = best_tax_euk, file = paste0(folder_path, "/federica_found_taxonomy_euk.txt"), quote = F, sep = "\t", row.names = F)

## Read hits found. Avoid running all steps again.
# best_tax_euk <- read_delim(file = paste0(folder_path, "federica_found_taxonomy_euk.txt"))
#best_tax_euk <- read_delim(file = paste0(folder_path, "federica_found_taxonomy_euk.txt"))

# all.info <- euk.info %>% bind_rows(prok.info)
```

clean global environment
```{r}
rm(list=setdiff(ls(), c("folder_path","taxonomies_federica", "best_tax_prok", "best_tax_euk", 'table.clean')))

```


Split the datasets based on status
For prokayotes

```{r}
# table_summ_prok <- best_tax_prok %>% 
#  select(taxonomy, status, size_mb, gc_percent) %>%
#   group_by(taxonomy, status) %>% 
#   skimr::skim(size_mb, gc_percent) %>%
#   left_join(best_tax_prok %>% 
#               group_by(taxonomy, status) %>% 
#               summarise(n_size_mb = n_distinct(size_mb),
#                         n_gc_percent = n_distinct(gc_percent))
#             )
# 
# table_summ_prok %>% head
# 
# table_summ_prok %>% distinct(skim_variable)
```

```{r}
# status
best_tax_prok %>% distinct(status)
# best_tax_prok_complete_genome <- best_tax_prok %>% filter(status == 'Complete Genome')
# best_tax_prok_scaffold <- best_tax_prok %>% filter(status == 'Scaffold')
# best_tax_prok_contig <- best_tax_prok %>% filter(status == 'Contig')
# best_tax_prok_chromosome <- best_tax_prok %>% filter(status == 'Chromosome')

# best_tax_prok %>% summarise(mean_size_mb = mean(size_mb),
                    #           max_size_mb = max(size_mb),
                    #           min_size_mb = min(size_mb),
                    #           n_size_mb = n_distinct(size_mb)
                    #           ) %>%
  # filter(n_size_mb >= 3)
```



```{r}
# Create function to gather statistics about the genomic information, using the highest level of assembly and the longer assembly

number_of_entries_prok <- best_tax_prok %>% count(taxonomy, sort = T )
number_of_entries_prok %>% filter(if_any(everything(), ~str_detect(., 'bacterium S5')))
best_tax_prok %>% filter(if_any(everything(), ~str_detect(., 'bacterium S5')))
# 
# # See the taxa with the most entries
# number_of_entries

#number_of_entries[order(number_of_entries$n,decreasing = T),]

## Tests
# df = best_tax_prok 
# taxa = "Xanthomonas campestris pv. campestris" # 80
# taxa = "Cronobacter turicensis" # 16
# taxa = "Acetobacter pasteurianus IFO 3283-32" # 1
# taxa = "Acetobacter pasteurianus IFO 3283-01" # 2
# 
# match("Acetobacter pasteurianus IFO 3283-32", number_of_entries$taxonomy)
# number_of_entries[match(taxa, number_of_entries$taxonomy), "n"]
# test_entries <- number_of_entries[match(taxa, number_of_entries$taxonomy), "n"]

## The function
source(file = "alternative_function.R")
## Function usage:
## genomic_traits(taxa, best_tax_prok)

## Testing function
taxa = "Acetobacter pasteurianus IFO 3283-01" 

genomic_traits(taxa, best_tax_prok)

# check on the larger ones from the table
larger_ones_prok <- number_of_entries_prok %>% 
                  slice_head(n = 64) %>% 
                  pull(taxonomy)

prok_taxonomy_search_using_purrr <- larger_ones_prok %>% map_df(., genomic_traits, best_tax_prok)

prok_taxonomy_search_using_purrr %>% count(highest_assembly_level)

# taxonomy_search_using_apply <- lapply(X = number_of_entries$taxonomy[order(number_of_entries$n, decreasing = F)][1100:1163], FUN = genomic_traits)
# removed_list <- as_tibble(do.call(rbind,taxonomy_search_using_apply))

```

For eukayotes
```{r}
# status
# best_tax_euk %>% distinct(status)
# table_summ_euk <- best_tax_euk %>% 
#  select(taxonomy, status, size_mb, gc_percent) %>%
#   group_by(taxonomy, status) %>% 
#   skimr::skim(size_mb, gc_percent) %>%
#   left_join(best_tax_euk %>% 
#               group_by(taxonomy, status) %>% 
#               summarise(n_size_mb = n_distinct(size_mb),
#                         n_gc_percent = n_distinct(gc_percent))
#             )
# 
# # table_summ_euk %>% distinct(skim_variable)
# # 
# # best_tax_euk %>% filter(taxonomy == "Alternaria alternata" & status == "Contig") %>%
# #   group_by(taxonomy, status) %>%
# #    summarise(n_size_mb = n_distinct(size_mb),
# #                         n_gc_percent = n_distinct(gc_percent)) 
# 
# best_tax_euk %>% 
#               group_by(taxonomy, status) %>% 
#               summarise(n_size_mb = n_distinct(size_mb),
#                         n_gc_percent = n_distinct(gc_percent)) %>%
#               filter(n_size_mb >= 3) 

```

Apply the function to the eukaryotic dataset
```{r}
# # See the taxa with the most entries
# number_of_entries
number_of_entries_euk <- best_tax_euk %>% count(taxonomy, sort = T )

# Testing function
genomic_traits("Aaosphaeria arxii", best_tax_euk)

# check on the larger ones from the table
larger_ones_euk <- number_of_entries_euk %>% 
                  slice_head(n = 64) %>% 
                  pull(taxonomy)

euk_taxonomy_search_using_purrr <- larger_ones_euk %>% map_df(., ~genomic_traits(., best_tax_euk))

euk_taxonomy_search_using_purrr %>% count(highest_assembly_level)
```

Clean environment
```{r}
rm(list=setdiff(ls(), c("taxonomies_federica", "best_tax_prok", "best_tax_euk", 'table.clean', 'genomic_traits')))
```

Add tax genome size and GC content to table Federica

Prokaryotes
```{r}
# only prokaryotes 
# full_dataset_prok2 <- table.clean %>%
#             filter(organism %in% best_tax_prok$taxonomy) %>%
#             bind_cols(map_df(.$organism, ~genomic_traits(., best_tax_prok)))

full_dataset_prok <- number_of_entries_prok$taxonomy %>%
  map_df(., genomic_traits, best_tax_prok)

# Store prok hits found
write.table(x = full_dataset_prok, file = paste0(folder_path, "/federica_full_prok.txt"), quote = F, sep = "\t", row.names = F)


# only eukaryotes 
# full_dataset_euk <- table.clean %>% 
#             filter(organism %in% best_tax_euk$taxonomy) %>%
#             bind_cols(map_df(.$organism, ~genomic_traits(., best_tax_euk)))

full_dataset_euk <- number_of_entries_euk$taxonomy %>%
  map_df(., genomic_traits, best_tax_euk)

# Store euk hits found
write.table(x = full_dataset_euk, file = paste0(folder_path, "/federica_full_euk.txt"), quote = F, sep = "\t", row.names = F)

```

Search and include lines at the whole table
```{r}
full_dataset <- full_dataset_euk %>% 
  select(-gc_percent_n_as) %>% 
  bind_rows(full_dataset_prok)

# Searching taxonomy from Federica_table into the full_datasets
## match(full_dataset$Taxonomy_from_dataset[1:2], table.clean$organism) # inverted match
## match(table.clean$organism[1:2], full_dataset$Taxonomy) # correct search

matched_Federica_table_to_full_dataset <- match(table.clean$organism, full_dataset$Taxonomy)

# test_vec <- c(NA,1,2,3,NA,NA,3)
# which(is.na(test_vec))
# create_fill_table <- function(matched_info){
#   if(is.na(matched_info)){
#     NA
#   }
#   full_dataset[matched_info,]
# }
# create_fill_table(test_vec)

filler_for_final_table <- full_dataset[matched_Federica_table_to_full_dataset,]

#sum(is.na(filler_for_final_table$Taxonomy))

Federica_table_with_genomic_traits_info <- bind_cols(table.clean, filler_for_final_table)

write.table(x = Federica_table_with_genomic_traits_info, file = paste0(folder_path, "/FEDERICA_MG_genomic_traits_added.txt"), quote = F, sep = "\t", row.names = F)

```

```{r}
# orgs_prok <- table.clean %>% 
#              filter(organism %in% best_tax_prok$taxonomy) %>%
#           # filter(organism %in% c("Desulfitobacterium hafniense DCB-2")) %>%
#            # distinct(organism) %>%
#             pull
# 
# full_dataset_prok1 <- table.clean %>% 
#                filter(organism %in% best_tax_prok$taxonomy) %>%
#               # filter(organism %in% c("Desulfitobacterium hafniense DCB-2")) %>%
#                bind_cols(map_df(orgs_prok, ~genomic_traits(., best_tax_prok)))


# prok_table_federica <- best_tax_prok %>% 
#   slice_head(n = 20) %>%
#   pull(taxonomy) %>%
#   map_df(., ~genomic_traits(., best_tax_prok)) %>%
#   rename(organism = Taxonomy) %>%
#   distinct() # remove duplicate rows
# 
# df_test_prok <- table.clean %>%
#   slice_head(n = 20) %>%
#   left_join(euk_table_federica) %>%
#   distinct()


# PS:
# couldn't find some taxa
# e.g., Magnetococcus sp. MC-1 (Federica table) -> Magnetococcus marinus MC-1 (prokayotic table)
# Pseudomonas syringae pv. phaseolicola 1448 (Federica table) -> there is any Pseudomonas syringae pv. phaseolicola 1448 in the prok table
# Symbiotaphrina kochii (Federica table) -> no Symbiotaphrina kochii in eukaryotic table
# 
# table.clean %>% select(number_organism_name) %>% filter(if_any(everything(), ~str_detect(., 'Symbiotaphrina')))
# euk.info %>% filter(if_any(everything(), ~str_detect(., 'Symbiotaphrina')))
# best_tax_euk %>% filter(if_any(everything(), ~str_detect(., 'Symbiotaphrina')))
```

Eukaryotes
```{r}

# orgs_euk <- table.clean %>% 
#              filter(organism %in% c("Aaosphaeria arxii", 'Abortiporus biennis', 'Absidia repens')) %>%
#              pull
# 
# full_dataset_euk <- table.clean %>% 
#             filter(organism %in% c("Aaosphaeria arxii", 'Abortiporus biennis', 'Absidia repens')) %>%
#             bind_cols(map_df(orgs_euk, ~genomic_traits(., best_tax_euk)))

# euk_table_federica <- best_tax_euk %>%
#   filter(taxonomy %in% c("Aaosphaeria arxii", 'Abortiporus biennis', 'Absidia repens')) %>%
#   pull(taxonomy) %>%
#   map_df(., ~genomic_traits(., best_tax_euk)) %>%
#   rename(organism = Taxonomy) %>%
#   distinct() # remove duplicate rows
# # 
# df_test_euk <- table.clean %>%
#    filter(organism %in% c("Aaosphaeria arxii", 'Abortiporus biennis', 'Absidia repens')) %>%
#  # slice_head(n = 20) %>%
#   left_join(euk_table_federica) %>%
#   distinct()


# df_test_euk %>% filter(organism == "Aaosphaeria arxii") %>% view
```

